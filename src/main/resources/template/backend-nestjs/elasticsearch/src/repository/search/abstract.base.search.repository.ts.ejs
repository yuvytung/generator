/* eslint-disable no-underscore-dangle */
import { ElasticsearchService } from "@nestjs/elasticsearch";
import { BaseEntity } from "../../domain/base/base.entity";
import Case from "case";
import {MongooseCollection} from "../../domain/base/mongoose.collection";

export abstract class AbstractBaseSearchRepository<E extends BaseEntity> {
  protected _entity: { name: string };

  protected constructor(protected readonly model: ElasticsearchService) {
    this.init();
  }

  init() {
    if (this.constructor.name.search(/SearchRepository$/g) < 0) {
      log.warn("Format of class name not right:", this.constructor.name);
    }
    this._entity = {
      name: <%- database === 'mongodb'
            ? `MongooseCollection[this.constructor.name.replace(/SearchRepository$/g, "")],`
            : `Case.snake(this.constructor.name.replace(/SearchRepository$/g, "")),` %>
    };
  }

  async search(keyword: string): Promise<E[] | undefined> {
    return this.model
      .search({
        index: this._entity.name,
        body: {
          query: {
            // eslint-disable-next-line camelcase
            multi_match: {
              query: keyword,
            },
          },
        },
      })
      .then((r) => (r.body?.hits?.hits?.map((v) => v._source) as E[]) || []);
  }
<%- database === 'mongodb' ? `
  async save(entity: E) {
    const searchEntity: E = {} as any;
    Object.assign(searchEntity, entity);
    searchEntity.id = (searchEntity.id || searchEntity._id)?.toString();
    delete searchEntity._id;
    return this.model.index({
      index: this._entity.name,
      id: searchEntity.id,
      body: {
        ...searchEntity,
      },
    });
  }
` : `
  async save(entity: E) {
    const searchEntity: E = {} as any;
    Object.assign(searchEntity, entity);
    return this.model.index({
      index: this._entity.name,
      id: searchEntity.id.toString(),
      body: {
        ...searchEntity,
      },
    });
  }
`
%>

  async delete(entityOrId: any) {
    const id = (entityOrId?.id || entityOrId)?.toString();
    return this.model.delete({
      index: this._entity.name,
      id,
    });
  }
}
